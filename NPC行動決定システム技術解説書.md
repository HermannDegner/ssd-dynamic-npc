# **NPC行動決定システム技術解説書**

## 1. 概要

本文書は、どうぶつの森風NPC（ノンプレイヤーキャラクター）の行動決定AIに関する技術的な解説を提供します。

このシステムは、構造主観力学（SSD）の理論に基づき、NPCが単なるスクリプトやランダムな動作ではなく、**個々の性格、欲求、経験（習慣）、そして環境からの影響**を総合的に判断して自律的に行動を決定することを目指しています。

意思決定は、優先順位の異なる4つの独立したシステムが連携することで実現されます。全体は `IntegratedNPCSelector` クラスによって統合・管理されます。

## 2. システムアーキテクチャ

NPCの行動は、1回の意思決定サイクル（ティック）ごとに、以下の階層的なプロセスを経て決定されます。**上位の層ほど優先度が高く**、下位層の判断を覆す（オーバーライドする）ことができます。

1.  **【第1層】 物理構造システム (Physical Structure System)**
    * **役割**: 天候や災害など、NPCが抗えない物理的制約を管理します。
    * **判断**: 現在の環境下で「強制される行動」や「禁止される行動」があるかを判断します。
    * **優先度**: **最優先**。強制行動が存在する場合、他のすべてのシステムの判断は無視されます。

2.  **【第2層】 基層システム (Basal System)**
    * **役割**: NPCの性格に基づいた根源的な「欲求」を管理します。
    * **判断**: 「誰かと話したい」「安心したい」といった欲求を生成し、それを満たすための行動を提案します。

3.  **【第3層】 整合慣性システム (Alignment Inertia System)**
    * **役割**: NPCの過去の「経験と学習」を管理します。
    * **判断**: 過去に成功した行動（習慣）を記憶し、現在の状況に似た過去の成功体験から行動を提案します。

4.  **【第4層】 行動選択システム (Action Selection System)**
    * **役割**: 下位層からの提案を統合し、最終的な行動を決定します。
    * **判断**: 「欲求」と「習慣」の強さに加え、「気まぐれ（ランダム性）」を考慮して、実行する行動を一つだけ選択します。

## 3. 各モジュールの詳細解説

### 3.1. 物理構造システム (`physical_structure_system.py`)

NPCの意思決定において、絶対的な制約条件を課すモジュールです。

* **役割**: NPCが逆らうことのできない物理環境（天候、災害、気温など）を管理します。NPCの意思決定において最も高い優先順位を持ちます。
* **主要クラスと概念**:
    * `PhysicalThreatLevel` (Enum): 物理的な脅威のレベル（NONEからCRITICALまで）を定義します。
    * `PhysicalCondition` (Dataclass): 特定の物理的状況（例: "heavy_rain"）と、それに紐づく脅威レベル、**強制行動** (`forced_actions`)、**禁止行動** (`forbidden_actions`) を定義します。
    * `PhysicalStructureSystem` (Class): システム全体を管理するメインクラスです。
        * `update_physical_state()`: 環境情報（`environment`）を受け取り、現在の物理状況を更新します。返り値として、強制行動が必要かどうかを真偽値で返します。
        * `get_forced_actions()`: 現在の状況でNPCが**必ず**実行しなければならない行動のリストを返します。このリストに項目がある場合、NPCの他の欲求や習慣はすべて無視されます。
        * `accumulated_heat`: 「未処理の圧力」や「不快度」を表す内部パラメータです。環境からのストレスや、禁止行動を実行した場合に上昇し、後述する行動選択における「気まぐれ」の発生確率に影響を与えます。

---

### 3.2. 基層システム (`ac_basal_system.py`)

NPCの「～したい」という行動の動機を生成するモジュールです。

* **役割**: NPCの根源的な欲求（基層衝動）を管理し、その性格に基づいて行動の動機を生成します。
* **主要クラスと概念**:
    * `BasalDrive` (Enum): NPCの行動源となる5つの基本欲求（COMFORT, SOCIAL, EXPLORATION, CREATION, RECOGNITION）を定義します。
    * `BasalState` (Dataclass): 各欲求の現在の満足度と、周囲の環境から受ける刺激を保持します。
    * `AnimalCrossingBasalSystem` (Class): 基層システム全体を管理するメインクラスです。
        * `__init__()`: NPCの性格タイプ（例: "peppy", "lazy"）に応じて、どの欲求を重視するかの重み付けを設定します。例えば、`peppy`（元気）な性格は `SOCIAL`（社交）の比重が高く設定されます。
        * `update_basal_state()`: 環境情報と最近の出来事（例: 会話の成功）を受け取り、欲求の満足度を更新します。
        * `get_suggested_actions()`: 現在活性化している欲求に基づいて、それを満たすための行動候補をスコア付きで提案します。
        * `get_emotional_state()`: 最も強く活性化している衝動に基づき、NPCの現在の感情（例: "friendly", "anxious"）を返します。

---

### 3.3. 整合慣性システム (`animal_crossing_alignment_inertia.py`)

NPCが経験から学び、「いつもの行動」を形成するためのモジュールです。

* **役割**: 成功した行動を「習慣」として記憶・強化し、NPCに一貫性のある個性的な振る舞いをさせます。
* **主要クラスと概念**:
    * `ActionPattern` (Dataclass): 学習される「行動パターン」を定義します。これは「特定の状況 (`trigger_conditions`)」と「特定の行動 (`action_sequence`)」の結びつきです。成功体験を重ねるほど `strength` が強くなります。
    * `AnimalCrossingAlignmentInertia` (Class): 整合慣性システム全体を管理するメインクラスです。
        * `record_action_attempt()`: NPCが行動を実行するたびに呼び出され、成功した場合は対応する行動パターンを強化、または新たに生成します。
        * `_decay_patterns()`: 長い間使われていない行動パターンの `strength` を徐々に減少させ、「忘却」をシミュレートします。
        * `get_pattern_suggestions()`: 現在の状況と欲求に合致する、学習済みの行動パターン（習慣）を提案します。
        * `_manage_inertia_capacity()`: NPCが学習できるパターンの総量（認知容量）を管理し、上限を超えると最も弱い習慣から忘れていきます。

---

### 3.4. 行動選択とシステム統合 (`jump_weighted_action_selection.py`)

すべての情報を統合し、最終的な意思決定を行うモジュールです。

* **役割**: 基層システムからの「欲求」と整合慣性システムからの「習慣」を統合し、さらに「ランダム性」を加えて、最終的に実行する行動を1つだけ選択します。
* **主要クラスと概念**:
    * `JumpWeightedActionSelector` (Class): 最終的な行動選択アルゴリズムを実装しています。
        * `select_action()`: 基層と慣性の両システムから行動提案を受け取り、それぞれのスコアとランダム要素を加味して最終スコアを算出します。最終スコアに基づき、重み付きのランダム選択で行動を決定します。
        * **跳躍的ランダム (Random Jump)**: `jump_probability` の確率で、全てのスコア計算を無視して完全にランダムな行動を選択します。これがNPCの「気まぐれ」や予測不能な行動を生み出します。`physical_structure_system` からの `heat`（ストレス）が高いほど、このランダムジャンプの発生確率が上昇します。
    * `IntegratedNPCSelector` (Class): **これまでに解説した4つのシステムすべてを統合し、NPCの行動決定サイクル全体を管理・実行するクラスです**。

## 4. 統合実行フロー

`IntegratedNPCSelector` の `update_and_select_action()` メソッドが、NPCの1回の意思決定サイクルに相当します。処理は以下の順序で実行されます。

1.  **物理層の確認**: `physical_system` を更新し、強制行動（オーバーライド）が必要かを確認します。必要であれば、その行動を即座に決定し、他の処理は行いません。同時に環境ストレスである `heat` を算出します。
2.  **基層の更新**: `basal_system` を更新し、NPCの現在の欲求状態を最新化します。
3.  **行動選択**: 強制行動がない場合、`action_selector` を使って行動を選択します。この際、基層からの「欲求提案」、整合慣性からの「習慣提案」をインプットとし、さらにステップ1で算出した `heat` を渡して「ランダムジャンプ」の確率を動的に調整します。
4.  **学習**: 選択された行動（成功したと仮定）を `inertia_system` に記録させ、習慣の学習・強化を行います。
5.  **ログ出力**: どのような理由で行動が選択されたか（`weighted`, `random_jump`, `physical_override`）を記録し、NPCの行動分析に役立てます。